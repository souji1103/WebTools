// @name         GF Hunter Skill Display Helper
// @namespace    jp.souji
// @version      0.6.4
// @author       souji
function loadExternalJS(){}function loadExternalCSS(){var a=document.getElementsByTagName("head"),b=document.createElement("link");b.setAttribute("tyle","text/css"),b.setAttribute("rel","stylesheet"),b.setAttribute("href","https://cdnjs.cloudflare.com/ajax/libs/remodal/1.0.7/remodal.css"),a[0].appendChild(b);var c=document.createElement("link");c.setAttribute("tyle","text/css"),c.setAttribute("rel","stylesheet"),c.setAttribute("href","https://cdnjs.cloudflare.com/ajax/libs/remodal/1.0.7/remodal-default-theme.min.css"),a[0].appendChild(c)}function getCardInfos(){cardList=[];var a=document.querySelectorAll(".js_cardList li");Array.prototype.forEach.call(a,function(a){cardList.push(CardDataBuilder.buildFromDom(a))})}function insertDetail(){var a=document.querySelectorAll(".js_cardList li");Array.prototype.forEach.call(a,function(a,b){if(cardList[b]){var c=SkillDetailDomGenerator.generate(cardList[b]);a.appendChild(c)}})}function saveToLocalStorage(){var a=localStorage.getItem(CONFIG.storageKey);a=a?JSON.parse(a):{},cardList.forEach(function(b){a[b.imageIdentifier]=b.toJson()}),localStorage.setItem(CONFIG.storageKey,JSON.stringify(a))}function appendDetailData(){var a=localStorage.getItem(CONFIG.storageKey);if(a){a=JSON.parse(a);var b=$(".leaderInfoArea .js_leaderArea")[0],c=CardDataBuilder.buildFromDom(b);$(".resultLine").remove(),$(".js_cardInfo").on("change",".js_changeOrderPulldown.formSortInner",function(){setTimeout(function(){appendDetailData()},500)});var d=parseInt($(".initialOffset").val(),10),e=$(".js_cardList"),f=e.find("ul"),g=[8+d,8+d,8+d,8+d],h=10,i=!1,j=c.cost,k=0,l=0,m=0;f.each(function(b,d){var e=$(d).find("li"),f=0,n=0,o=0;e.each(function(b,c){var d=$(c).find("img")[1].getAttribute("src"),e=d.match(/.+\/([^/]+)\.jpg$/)[1],h=a[e];return!h||(h.type===CardData.Type.DAMAGE_RATIO?f+=h.value:h.type===CardData.Type.DAMAGE_ABSOLUTE?n+=h.value:h.type===CardData.Type.ENHANCE_SELF_3&&(o+=h.value),$(c).append($('<div style="position: absolute; top: 47px; margin-left: -10px; background-color: #333; color: #fff; border: 1px solid #34f; padding: 1px;">'+h.cost+"</div>")),$(c).append($('<div style="position: absolute;top: 1px;margin-left: 17px;width: 0;height:0;color: #fff;border: 13px solid transparent;border-top: 18px solid #a00;"></div>')),$(c).append($('<div style="position: absolute;top: 0px;margin-left: 23px;font-size: 80%;color: #fff;">'+g[b]+"</div>")),k+=h.cost,void(g[b]=g[b]+8-h.cost))}),l+=f,m+=o;var p=$('<div class="resultLine" style="background-color: #555; margin: 5px 15px 5px 5px; padding: 0px 3px; text-align: center;">');o&&p.append($('<span style="color: #6ff;">攻援 + '+o+"%</span>")),f&&p.append($('<span style="color: #f66;">ダメージ '+f+"%</span>")),j-=0===b?h:8,j<=0&&(c.type===CardData.Type.DAMAGE_RATIO?p.append($('<span style="color: #f66;"> (＋リーダー '+c.value+"%)</span>")):c.type===CardData.Type.DAMAGE_RATIO,j+=2*c.cost,i=!0),$(d).append(p)})}}var CONFIG={};CONFIG.valueRatio=[0,0,0,0,1,1,1,1,1,2,3,4,5,7,9],CONFIG.costDelta=[0,0,0,0,0,0,0,0,0,-1,-1,-1,-2,-2,-2],CONFIG.storageKey="jp.souji.gf_hunter_skill_display_helper",CONFIG.urlPath={browse:"raidwar/union/form-skill-deck",edit:"raidwar/union/form-skill-deck-edit"},CONFIG.targetEnemy="夜行性激レア";var CardData=function(a,b,c,d,e,f,g,h,i,j,k){this.name=a,this.title=b,this.style=c,this.rarity=d,this.cost=e,this.type=f,this.lv=g,this.boost=h,this.value=i,this.duration=j,this.imageUrl=k,this.baseCost=this.cost-CONFIG.costDelta[g-1],this.valueStep=CardDataUtil.getValueStep(this.type,this.rarity,this.baseCost,this.boost,CONFIG.valueRatio[g-1]),this.baseValue=this.value-this.valueStep*CONFIG.valueRatio[g-1];var l;l=this.type===CardData.Type.DAMAGE_RATIO?new ratioDamageRankDecider:this.type===CardData.Type.ENHANCE_SELF_3?new selfEnhance3TernRankDecider:this.type===CardData.Type.ENHANCE_SELF_1?new selfEnhance1TernRankDecider:this.type===CardData.Type.ENHANCE_TEAM?new teamEnhanceRankDecider:new cardRankDecider,this.rank=l.getRankAt(this),this.imageIdentifier=this.imageUrl.match(/.+\/([^/]+)\.jpg$/)[1]};CardData.prototype.getCostAt=function(a){return this.baseCost+CONFIG.costDelta[a-1]},CardData.prototype.getValueAt=function(a){return this.baseValue+Math.ceil(this.valueStep*CONFIG.valueRatio[a-1])},CardData.prototype.toJson=function(){return{name:this.name,title:this.title,style:this.style,rarity:this.rarity,cost:this.cost,type:this.type,lv:this.lv,boost:this.boost,value:this.value,duration:this.duration,rank:this.rank,imageIdentifier:this.imageIdentifier}},CardData.Style={COOL:"cool",POP:"pop",SWEET:"sweet"},CardData.Type={DAMAGE_RATIO:"d_ratio",DAMAGE_ABSOLUTE:"d_absolute",ENHANCE_SELF_3:"enhance_self_3",ENHANCE_SELF_1:"enhance_self_1",ENHANCE_TEAM:"enhance_team"},CardData.Rank={S:"S",A:"A",B:"B",C:"C",D:"D"},CardDataUtil={},CardDataUtil.getValueStep=function(a,b,c,d,e){if("SSR"!==this.rarity)return d/e;switch(a){case ENHANCE_SELF_3:case ENHANCE_TEAM:if(c<=6)return 1;if(c<=9)return 1.5;if(c<=11)return 2;break;case ENHANCE_SELF_1:if(c<=6)return 2;if(c<=9)return 3;if(c<=11)return 4}return d/e};var cardRankDecider=function(){};cardRankDecider.prototype.getRankAt=function(a){return"UR"===a.rarity?CardData.Rank.S:CardData.Rank.D};var ratioDamageRankDecider=function(){};ratioDamageRankDecider.prototype.getRankAt=function(a){if("UR"===a.rarity)return CardData.Rank.S;switch(a.baseCost){case 8:if(a.baseValue>=160)return CardData.Rank.A;if(a.baseValue>=150)return CardData.Rank.B;if(a.baseValue>=140)return CardData.Rank.C;break;case 9:if(a.baseValue>=160)return CardData.Rank.B;if(a.baseValue>=150)return CardData.Rank.C;break;case 12:if(a.baseValue>=245)return CardData.Rank.A;if(a.baseValue>=230)return CardData.Rank.B;if(a.baseValue>=215)return CardData.Rank.C;break;case 13:if(a.baseValue>=245)return CardData.Rank.B;if(a.baseValue>=230)return CardData.Rank.C;break;case 16:if(a.baseValue>=335)return CardData.Rank.A;if(a.baseValue>=310)return CardData.Rank.B;if(a.baseValue>=285)return CardData.Rank.C}return CardData.Rank.D};var selfEnhance3TernRankDecider=function(){};selfEnhance3TernRankDecider.prototype.getRankAt=function(a){if("UR"===a.rarity)return CardData.Rank.S;switch(a.baseCost){case 5:if(a.baseValue>=16)return CardData.Rank.A;if(a.baseValue>=14)return CardData.Rank.B;if(a.baseValue>=12)return CardData.Rank.C;break;case 6:if(a.baseValue>=16)return CardData.Rank.B;if(a.baseValue>=14)return CardData.Rank.C;break;case 8:if(a.baseValue>=24)return CardData.Rank.A;if(a.baseValue>=22)return CardData.Rank.B;if(a.baseValue>=20)return CardData.Rank.C;break;case 9:if(a.baseValue>=24)return CardData.Rank.B;if(a.baseValue>=22)return CardData.Rank.C;break;case 10:if(a.baseValue>=34)return CardData.Rank.A;if(a.baseValue>=31)return CardData.Rank.B;if(a.baseValue>=28)return CardData.Rank.C;break;case 11:if(a.baseValue>=34)return CardData.Rank.B;if(a.baseValue>=31)return CardData.Rank.C}return CardData.Rank.D};var selfEnhance1TernRankDecider=function(){};selfEnhance1TernRankDecider.prototype.getRankAt=function(a){return"UR"===a.rarity?CardData.Rank.S:CardData.Rank.D};var teamEnhanceRankDecider=function(){};teamEnhanceRankDecider.prototype.getRankAt=function(a){return"UR"===a.rarity?CardData.Rank.S:CardData.Rank.D};var CardDataBuilder={};CardDataBuilder.buildFromDom=function(a){var b=a.querySelector(".headline"),c=b.innerText.match(/\[(\S+)\](\S+)\((\S+)\)/);if(!c)return null;var l,m,d=b.classList.contains("cool")?CardData.Style.COOL:b.classList.contains("pop")?CardData.Style.POP:CardData.Style.SWEET,e=a.querySelector(".cardItemContent"),f=e.querySelector(".bgLvUpEffect span").innerText,g=f.match(/\+(\d+)/),h=g&&g[1]?g[1]:0,i=e.querySelector("p.fs12").innerText.trim(),j=e.querySelector(".mt3.fs11 > span.fcDarkOrange").innerText.trim();switch(m=i.indexOf("ダメージ")>=0?/%/.test(i)?CardData.Type.DAMAGE_RATIO:CardData.Type.DAMAGE_ABSOLUTE:i.indexOf("班員の全ガール")>=0?CardData.Type.ENHANCE_TEAM:j.indexOf("3アタック")?CardData.Type.ENHANCE_SELF_3:CardData.Type.ENHANCE_SELF_1){case CardData.Type.DAMAGE_RATIO:l=i.match(/に攻援力の(\d+)\%分のダメージ/);break;case CardData.Type.DAMAGE_ABSOLUTE:l=i.match(/に(\d+)ダメージ/);break;case CardData.Type.ENHANCE_SELF_3:case CardData.Type.ENHANCE_SELF_1:case CardData.Type.ENHANCE_TEAM:l=i.match(/攻援力を(\d+)\%UP/)}return new CardData(c[2],c[1],d,c[3],parseInt(e.querySelector(".outlinePink").innerText.trim().substr(1),10),m,parseInt(e.querySelector(".round5.pt2.fcWhite.bgOrange").innerText.trim().match(/\d+$/),10),parseInt(h,10),parseInt(l[1],10),"",e.querySelector("img").src)};var levelCands=[1,5,10,11,12,13,14,15],SkillDetailDomGenerator={};SkillDetailDomGenerator.generate=function(a){var b="padding:2px; text-align:center; color:#666",c="padding:2px; text-align:center; color:#c00",d=$('<div><table class="skillDetail"><tbody></tbody></table></div>'),e=d.find("tbody"),f=$('<tr><th class="fs11" style="padding: 0px 10px">Rank</th><th class="fs11" style="color:#333; padding:2px;">Lv</th></tr>'),g=$('<tr><td rowspan="2" style="text-align: center; vertical-align: middle; font-size: large; color: #ff0099">'+a.rank+'</td><th class="fs11" style="color:#333; padding:2px;">Value</th></tr>'),h=$('<tr><th class="fs11" style="color:#333; padding:2px;">Cost</th></tr>');return levelCands.forEach(function(d){var e=$('<td class="fs11">'+d+"</td>"),i=$('<td class="fs11">'+a.getValueAt(d)+"</td>"),j=$('<td class="fs11">'+a.getCostAt(d)+"</td>");1==d&&a.lv>=1&&a.lv<=4||5==d&&a.lv>=5&&a.lv<=9||d>=10&&d==a.lv?(e.attr("style",c),i.attr("style",c),j.attr("style",c)):(e.attr("style",b),i.attr("style",b),j.attr("style",b)),f.append(e),g.append(i),h.append(j)}),e.append(f),e.append(g),e.append(h),d[0]};var cardList=[];!function(){var a;if(location.pathname.indexOf(CONFIG.urlPath.edit)>=0){var b=$('<div class="mt3"><div class="js_btnOpenPopup btnPrimary w300 jsTouchActive">ハンター声援を出力</div></div>'),c=$('<div class="mt3"><div class="js_btnOpenPopup btnPrimary w300 jsTouchActive">カードデータを保存</div></div>');a=$("#ac_sortArea > div:nth-of-type(2)"),a.append(b),a.append(c),b.on("click",function(){getCardInfos(),insertDetail()}),c.on("click",function(){getCardInfos(),saveToLocalStorage(),alert("保存しました")})}else if(location.pathname.indexOf(CONFIG.urlPath.browse)>=0){var d=$('<div class="mt5 btnPrimary jsTouchActive w300">詳細データを表示</div>'),e=$('<input class="initialOffset" type="text" size="1" value="0">');a=$(".outline > section:nth-of-type(4) > div:nth-of-type(2)"),a.append(d),a.append(e),d.on("click",function(){appendDetailData()})}}();